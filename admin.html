<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Flow English</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Flow English">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: containerFloat 6s ease-in-out infinite;
        }

        @keyframes containerFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        .tab-container {
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }
        
        .tab-button {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0 5px;
            backdrop-filter: blur(10px);
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            color: white;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            max-width: 600px;
            animation: cardFloat 4s ease-in-out infinite;
        }

        @keyframes cardFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group.full-width {
            flex: none;
            width: 100%;
        }
        
        .price-input {
            display: none;
        }
        
        .price-input.show {
            display: block;
        }
        
        .create-btn {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }
        
        .create-btn:hover {
            background: #218838;
        }
        
        .create-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* Edit User Tab Styles */
        .search-section {
            margin-bottom: 30px;
        }
        
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .search-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .search-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .search-btn:hover {
            background: #0056b3;
        }
        
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .user-item:hover {
            background: #f8f9fa;
        }
        
        .user-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .user-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .change-password-btn {
            background: #ffc107;
            color: #212529;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .change-password-btn:hover {
            background: #e0a800;
        }
        
        .view-classes-btn {
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .view-classes-btn:hover {
            background: #138496;
        }
        
        .password-section, .classes-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .save-btn:hover {
            background: #218838;
        }
        
        .classes-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .class-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background: white;
        }
        
        .class-item h5 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .class-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        /* Requests Tab Styles */
        .requests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .refresh-btn {
            background: #17a2b8;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .refresh-btn:hover {
            background: #138496;
        }
        
        .requests-count {
            color: #666;
            font-size: 14px;
        }
        
        .requests-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .request-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .request-info {
            flex: 1;
        }
        
        .request-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .request-details {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-declined {
            background: #f8d7da;
            color: #721c24;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .edit-btn {
            background: #ffc107;
            color: #212529;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .edit-btn:hover {
            background: #e0a800;
        }
        
        .confirm-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .confirm-btn:hover {
            background: #218838;
        }
        
        .decline-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .decline-btn:hover {
            background: #c82333;
        }
        
        .edit-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        .edit-form.show {
            display: block;
        }
        
        .edit-form .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .edit-form .form-group {
            flex: 1;
        }
        
        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .edit-form textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .edit-form-buttons {
            display: flex;
            gap: 10px;
        }
        
        .save-edit-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .save-edit-btn:hover {
            background: #218838;
        }
        
        .cancel-edit-btn {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .cancel-edit-btn:hover {
            background: #5a6268;
        }
        
        .teacher-selection {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        .teacher-selection.show {
            display: block;
        }
        
        .teacher-selection h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .teacher-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .teacher-option {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .teacher-option:hover {
            background: #f8f9fa;
        }
        
        .teacher-option.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .teacher-option h5 {
            margin: 0 0 5px 0;
        }
        
        .teacher-option p {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Calendar Styles */
        .calendar-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }
        
        .calendar-container {
            margin-top: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav-btn:hover {
            background: #0056b3;
        }
        
        .current-month {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }
        
        .calendar-day-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #666;
        }
        
        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 80px;
            border: 1px solid #f0f0f0;
            position: relative;
        }
        
        .calendar-day.other-month {
            background: #f8f9fa;
            color: #ccc;
        }
        
        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .class-item {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-bottom: 2px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .class-item:hover {
            background: #218838;
        }
        
        .class-item.teacher {
            background: #17a2b8;
        }
        
        .class-item.teacher:hover {
            background: #138496;
        }
        
        .class-item.student {
            background: #28a745;
        }
        
        .class-item.student:hover {
            background: #218838;
        }
        
        .class-details {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .class-details h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .class-details p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .class-details .notes {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 3px;
            margin-top: 10px;
            font-style: italic;
        }
        
        /* Notifications Styles */
        .notification-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .mark-read-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .mark-read-btn:hover {
            background: #218838;
        }
        
        .notifications-count {
            color: #666;
            font-size: 14px;
        }
        
        .notifications-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .notification-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .notification-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .notification-item.unread {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        
        .notification-item.read {
            opacity: 0.7;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .notification-type {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .notification-time {
            color: #666;
            font-size: 12px;
        }
        
        .notification-message {
            color: #555;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .notification-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .mark-read-action {
            background: #6c757d;
            color: white;
        }
        
        .mark-read-action:hover {
            background: #5a6268;
        }
        
        .delete-action {
            background: #dc3545;
            color: white;
        }
        
        .delete-action:hover {
            background: #c82333;
        }
        
        .class-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .cancel-btn {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .cancel-btn:hover {
            background: #c82333;
        }
        
        .cancel-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* Payments Tab Styles */
        .payments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .month-selector input[type="month"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .payment-summary {
            margin-bottom: 30px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .stat-card span {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .payments-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .payment-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .student-info h4 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        
        .student-info p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }
        
        .payment-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }
        
        .payment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            text-align: center;
        }
        
        .detail-item h5 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 12px;
            font-weight: 600;
        }
        
        .detail-item span {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .payment-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .payment-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .payment-input input {
            width: 100px;
            padding: 16px 20px;
            border: 2px solid #e8f0fe;
            border-radius: 20px;
            font-size: 16px;
            background-color: #f8faff;
            transition: all 0.3s ease;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .update-payment-btn {
            background: #28a745;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .update-payment-btn:hover {
            background: #218838;
        }
        
        .mark-paid-btn {
            background: #007bff;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .mark-paid-btn:hover {
            background: #0056b3;
        }
        
        .mark-paid-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="dashboard-modern">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Admin Dashboard</h1>
            <p class="dashboard-subtitle">Manage users, requests, and system settings</p>
        </div>
        
        <div class="tab-container">
            <div class="modern-tabs">
                <button class="modern-tab active" onclick="showTab('addUser')">Add User</button>
                <button class="modern-tab" onclick="showTab('editUser')">Edit User</button>
                <button class="modern-tab" onclick="showTab('requests')">Requests</button>
                <button class="modern-tab" onclick="showTab('calendar')">Calendar</button>
                <button class="modern-tab" onclick="showTab('notifications')">Notifications <span id="notificationBadge" class="notification-badge" style="display: none;">0</span></button>
                <button class="modern-tab" onclick="showTab('payments')">Payments</button>
                <button class="modern-tab" onclick="showTab('manageUsers')">Manage Users</button>
                <button class="modern-tab" onclick="showTab('reports')">Reports</button>
            </div>
            
            <!-- Add User Tab -->
            <div id="addUser" class="tab-content active">
                <div class="modern-form-card">
                    <h2 class="form-card-title">Add New User</h2>
                    <form id="addUserForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">Username *</label>
                                <input type="text" id="username" name="username" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="password">Password *</label>
                                <input type="password" id="password" name="password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="role">Role *</label>
                                <select id="role" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group full-width price-input" id="priceGroup">
                            <label for="pricePerClass">Price per Class ($)</label>
                            <input type="number" id="pricePerClass" name="pricePerClass" min="0" step="0.01">
                        </div>
                        
                        <button type="submit" class="create-btn" id="createBtn">Create User</button>
                    </form>
                </div>
            </div>
            
            <!-- Edit User Tab -->
            <div id="editUser" class="tab-content">
                <div class="form-card">
                    <h2>Edit User</h2>
                    
                    <!-- Search Section -->
                    <div class="search-section">
                        <label for="userSearch">Search Users by Username:</label>
                        <div class="search-input-group">
                            <input type="text" id="userSearch" placeholder="Enter username to search...">
                            <button type="button" id="searchBtn" class="search-btn">Search</button>
                        </div>
                    </div>
                    
                    <!-- User List -->
                    <div id="userList" class="user-list"></div>
                    
                    <!-- User Details Modal -->
                    <div id="userModal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3 id="modalTitle">User Details</h3>
                            
                            <div id="userInfo" class="user-info"></div>
                            
                            <div class="action-buttons">
                                <button id="deleteUserBtn" class="delete-btn">Delete User</button>
                                <button id="changePasswordBtn" class="change-password-btn">Change Password</button>
                                <button id="viewClassesBtn" class="view-classes-btn">View Classes</button>
                            </div>
                            
                            <!-- Password Change Section -->
                            <div id="passwordChangeSection" class="password-section" style="display: none;">
                                <h4>Change Password</h4>
                                <div class="form-group">
                                    <label for="newPassword">New Password:</label>
                                    <input type="password" id="newPassword" minlength="6">
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm Password:</label>
                                    <input type="password" id="confirmPassword" minlength="6">
                                </div>
                                <button id="savePasswordBtn" class="save-btn">Save Password</button>
                            </div>
                            
                            <!-- Classes Section -->
                            <div id="classesSection" class="classes-section" style="display: none;">
                                <h4>User Classes</h4>
                                <div id="classesList" class="classes-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Requests Tab -->
            <div id="requests" class="tab-content">
                <div class="form-card">
                    <h2>Class Requests</h2>
                    
                    <div class="requests-header">
                        <button id="refreshRequestsBtn" class="refresh-btn">Refresh Requests</button>
                        <span id="requestsCount" class="requests-count">Loading...</span>
                    </div>
                    
                    <div id="requestsList" class="requests-list">
                        <!-- Requests will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Calendar Tab -->
            <div id="calendar" class="tab-content">
                <div class="form-card">
                    <h2>Class Calendar</h2>
                    
                    <div class="calendar-filters">
                        <div class="filter-group">
                            <label for="userFilter">Filter by User:</label>
                            <select id="userFilter">
                                <option value="">All Users</option>
                                <option value="students">All Students</option>
                                <option value="teachers">All Teachers</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="specificUserFilter">Specific User:</label>
                            <select id="specificUserFilter">
                                <option value="">Select User</option>
                            </select>
                        </div>
                        <button id="refreshCalendarBtn" class="refresh-btn">Refresh Calendar</button>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button class="nav-btn" id="prevMonth">← Previous</button>
                                <button class="nav-btn" id="nextMonth">Next →</button>
                            </div>
                            <div class="current-month" id="currentMonth"></div>
                        </div>
                        
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notifications Tab -->
            <div id="notifications" class="tab-content">
                <div class="form-card">
                    <h2>Notifications</h2>
                    
                    <div class="notifications-header">
                        <button id="refreshNotificationsBtn" class="refresh-btn">Refresh</button>
                        <button id="markAllReadBtn" class="mark-read-btn">Mark All as Read</button>
                        <span id="notificationsCount" class="notifications-count">Loading...</span>
                    </div>
                    
                    <div id="notificationsList" class="notifications-list">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <div class="form-card">
                    <h2>Monthly Payment Summary</h2>
                    
                    <div class="payments-header">
                        <div class="month-selector">
                            <label for="paymentMonth">Select Month:</label>
                            <input type="month" id="paymentMonth" onchange="loadPaymentSummary()">
                        </div>
                        <button id="refreshPaymentsBtn" class="refresh-btn">Refresh</button>
                    </div>
                    
                    <div class="payment-summary">
                        <div class="summary-stats">
                            <div class="stat-card">
                                <h4>Total Students</h4>
                                <span id="totalStudents">0</span>
                            </div>
                            <div class="stat-card">
                                <h4>Total Classes</h4>
                                <span id="totalClasses">0</span>
                            </div>
                            <div class="stat-card">
                                <h4>Total Revenue</h4>
                                <span id="totalRevenue">$0</span>
                            </div>
                            <div class="stat-card">
                                <h4>Total Paid</h4>
                                <span id="totalPaid">$0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="paymentsList" class="payments-list">
                        <!-- Payment summaries will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Manage Users Tab -->
            <div id="manageUsers" class="tab-content">
                <h2>Manage Users</h2>
                <p>User management functionality coming soon...</p>
            </div>
            
            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2>Reports</h2>
                <p>Reports functionality coming soon...</p>
            </div>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script src="sw-register.js"></script>
    
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { createUserWithEmailAndPassword, updatePassword, deleteUser } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js';
        import { doc, setDoc, collection, query, where, getDocs, deleteDoc, writeBatch, updateDoc } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';

        // Tab functionality
        window.showTab = function(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        };

        // Role change handler
        const roleSelect = document.getElementById('role');
        const priceGroup = document.getElementById('priceGroup');
        const priceInput = document.getElementById('pricePerClass');

        roleSelect.addEventListener('change', function() {
            if (this.value === 'teacher') {
                priceGroup.classList.add('show');
                priceInput.required = true;
            } else {
                priceGroup.classList.remove('show');
                priceInput.required = false;
                priceInput.value = '';
            }
        });

        // Form submission
        const addUserForm = document.getElementById('addUserForm');
        const createBtn = document.getElementById('createBtn');

        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Disable button and show loading state
            createBtn.disabled = true;
            createBtn.textContent = 'Creating User...';
            
            try {
                const formData = new FormData(addUserForm);
                const username = formData.get('username').trim();
                const email = formData.get('email').trim();
                const password = formData.get('password');
                const role = formData.get('role');
                const pricePerClass = formData.get('pricePerClass');

                // Validate required fields
                if (!username || !email || !password || !role) {
                    throw new Error('Please fill in all required fields.');
                }

                // Validate teacher price
                if (role === 'teacher' && (!pricePerClass || parseFloat(pricePerClass) <= 0)) {
                    throw new Error('Please enter a valid price per class for teachers.');
                }

                // Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Prepare user data for Firestore
                const userData = {
                    username: username,
                    email: email,
                    role: role,
                    createdAt: new Date(),
                    createdBy: 'admin'
                };

                // Add price per class if teacher
                if (role === 'teacher') {
                    userData.pricePerClass = parseFloat(pricePerClass);
                }

                // Save user data to Firestore
                await setDoc(doc(db, 'users', user.uid), userData);

                // Create notification for admin
                await createNotification('admin', 'user_created', `New ${role} user "${username}" has been created.`);

                // Show success message
                alert(`User created successfully!\nUsername: ${username}\nEmail: ${email}\nRole: ${role}`);

                // Reset form
                addUserForm.reset();
                priceGroup.classList.remove('show');

            } catch (error) {
                console.error('Error creating user:', error);
                
                let errorMessage = 'Failed to create user. ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'Email is already registered.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'Password is too weak.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'Invalid email format.';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            } finally {
                // Re-enable button
                createBtn.disabled = false;
                createBtn.textContent = 'Create User';
            }
        });

        // Edit User Tab Functionality
        let currentUser = null;
        let currentUserAuth = null;

        // Search functionality
        const userSearch = document.getElementById('userSearch');
        const searchBtn = document.getElementById('searchBtn');
        const userList = document.getElementById('userList');

        searchBtn.addEventListener('click', searchUsers);
        userSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });

        async function searchUsers() {
            const searchTerm = userSearch.value.trim();
            if (!searchTerm) {
                alert('Please enter a username to search');
                return;
            }

            try {
                searchBtn.textContent = 'Searching...';
                searchBtn.disabled = true;

                // Query Firestore for users with matching username
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '>=', searchTerm), where('username', '<=', searchTerm + '\uf8ff'));
                const querySnapshot = await getDocs(q);

                userList.innerHTML = '';

                if (querySnapshot.empty) {
                    userList.innerHTML = '<p>No users found matching your search.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <h4>${userData.username}</h4>
                        <p><strong>Email:</strong> ${userData.email}</p>
                        <p><strong>Role:</strong> ${userData.role}</p>
                        ${userData.pricePerClass ? `<p><strong>Price per Class:</strong> $${userData.pricePerClass}</p>` : ''}
                    `;
                    userItem.addEventListener('click', () => openUserModal(doc.id, userData));
                    userList.appendChild(userItem);
                });

            } catch (error) {
                console.error('Error searching users:', error);
                alert('Error searching users. Please try again.');
            } finally {
                searchBtn.textContent = 'Search';
                searchBtn.disabled = false;
            }
        }

        // Modal functionality
        const userModal = document.getElementById('userModal');
        const closeBtn = document.querySelector('.close');
        const modalTitle = document.getElementById('modalTitle');
        const userInfo = document.getElementById('userInfo');
        const deleteUserBtn = document.getElementById('deleteUserBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const viewClassesBtn = document.getElementById('viewClassesBtn');
        const passwordChangeSection = document.getElementById('passwordChangeSection');
        const classesSection = document.getElementById('classesSection');

        closeBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === userModal) {
                closeModal();
            }
        });

        function openUserModal(userId, userData) {
            currentUser = { id: userId, ...userData };
            modalTitle.textContent = `User Details - ${userData.username}`;
            
            userInfo.innerHTML = `
                <p><strong>Username:</strong> ${userData.username}</p>
                <p><strong>Email:</strong> ${userData.email}</p>
                <p><strong>Role:</strong> ${userData.role}</p>
                <p><strong>Created:</strong> ${userData.createdAt ? userData.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
                ${userData.pricePerClass ? `<p><strong>Price per Class:</strong> $${userData.pricePerClass}</p>` : ''}
            `;

            // Hide sections
            passwordChangeSection.style.display = 'none';
            classesSection.style.display = 'none';

            userModal.style.display = 'block';
        }

        function closeModal() {
            userModal.style.display = 'none';
            currentUser = null;
            currentUserAuth = null;
        }

        // Delete user functionality
        deleteUserBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            const confirmed = confirm(`Are you sure you want to delete user "${currentUser.username}"? This action cannot be undone and will also delete all related classes.`);
            if (!confirmed) return;

            try {
                deleteUserBtn.textContent = 'Deleting...';
                deleteUserBtn.disabled = true;

                // Delete user's classes first
                const classesRef = collection(db, 'classes');
                const classesQuery = query(classesRef, where('userId', '==', currentUser.id));
                const classesSnapshot = await getDocs(classesQuery);

                const batch = writeBatch(db);
                
                // Delete all user's classes
                classesSnapshot.forEach((classDoc) => {
                    batch.delete(classDoc.ref);
                });

                // Delete user document
                batch.delete(doc(db, 'users', currentUser.id));

                // Commit the batch
                await batch.commit();

                // Create notification for admin
                await createNotification('admin', 'user_deleted', `User "${currentUser.username}" has been deleted along with all related classes.`);

                alert(`User "${currentUser.username}" and all related classes have been deleted successfully.`);
                closeModal();
                searchUsers(); // Refresh the list

            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user. Please try again.');
            } finally {
                deleteUserBtn.textContent = 'Delete User';
                deleteUserBtn.disabled = false;
            }
        });

        // Change password functionality
        changePasswordBtn.addEventListener('click', () => {
            passwordChangeSection.style.display = passwordChangeSection.style.display === 'none' ? 'block' : 'none';
            classesSection.style.display = 'none';
        });

        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const savePasswordBtn = document.getElementById('savePasswordBtn');

        savePasswordBtn.addEventListener('click', async () => {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in both password fields.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match.');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }

            try {
                savePasswordBtn.textContent = 'Updating...';
                savePasswordBtn.disabled = true;

                // Note: This requires admin SDK or user re-authentication
                // For now, we'll show a message that this requires admin privileges
                alert('Password change requires admin privileges. This feature will be implemented with Firebase Admin SDK.');

            } catch (error) {
                console.error('Error updating password:', error);
                alert('Error updating password. Please try again.');
            } finally {
                savePasswordBtn.textContent = 'Save Password';
                savePasswordBtn.disabled = false;
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
            }
        });

        // View classes functionality
        viewClassesBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            try {
                viewClassesBtn.textContent = 'Loading...';
                viewClassesBtn.disabled = true;

                const classesRef = collection(db, 'classes');
                const classesQuery = query(classesRef, where('userId', '==', currentUser.id));
                const classesSnapshot = await getDocs(classesQuery);

                const classesList = document.getElementById('classesList');
                classesList.innerHTML = '';

                if (classesSnapshot.empty) {
                    classesList.innerHTML = '<p>No classes found for this user.</p>';
                } else {
                    classesSnapshot.forEach((classDoc) => {
                        const classData = classDoc.data();
                        const classItem = document.createElement('div');
                        classItem.className = 'class-item';
                        classItem.innerHTML = `
                            <h5>${classData.title || 'Untitled Class'}</h5>
                            <p><strong>Date:</strong> ${classData.date ? classData.date.toDate().toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Time:</strong> ${classData.time || 'N/A'}</p>
                            <p><strong>Status:</strong> ${classData.status || 'N/A'}</p>
                        `;
                        classesList.appendChild(classItem);
                    });
                }

                classesSection.style.display = 'block';
                passwordChangeSection.style.display = 'none';

            } catch (error) {
                console.error('Error fetching classes:', error);
                alert('Error fetching classes. Please try again.');
            } finally {
                viewClassesBtn.textContent = 'View Classes';
                viewClassesBtn.disabled = false;
            }
        });

        // Requests Tab Functionality
        let allRequests = [];
        let allTeachers = [];

        // Initialize requests when tab is shown
        window.showTab = function(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load requests if requests tab is selected
            if (tabName === 'requests') {
                loadRequests();
            }
        };

        // Load requests functionality
        const refreshRequestsBtn = document.getElementById('refreshRequestsBtn');
        const requestsList = document.getElementById('requestsList');
        const requestsCount = document.getElementById('requestsCount');

        refreshRequestsBtn.addEventListener('click', loadRequests);

        async function loadRequests() {
            try {
                refreshRequestsBtn.textContent = 'Loading...';
                refreshRequestsBtn.disabled = true;

                // Fetch all requests
                const requestsRef = collection(db, 'requests');
                const requestsQuery = query(requestsRef);
                const requestsSnapshot = await getDocs(requestsQuery);

                allRequests = [];
                requestsList.innerHTML = '';

                if (requestsSnapshot.empty) {
                    requestsList.innerHTML = '<p>No requests found.</p>';
                    requestsCount.textContent = '0 requests';
                    return;
                }

                // Process each request
                for (const requestDoc of requestsSnapshot.docs) {
                    const requestData = requestDoc.data();
                    
                    // Get student name from users collection
                    let studentName = 'Unknown Student';
                    try {
                        const studentDoc = await getDoc(doc(db, 'users', requestData.studentId));
                        if (studentDoc.exists()) {
                            studentName = studentDoc.data().username;
                        }
                    } catch (error) {
                        console.error('Error fetching student name:', error);
                    }

                    allRequests.push({
                        id: requestDoc.id,
                        ...requestData,
                        studentName: studentName
                    });
                }

                // Sort requests by date (oldest first)
                allRequests.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Display requests
                displayRequests();
                requestsCount.textContent = `${allRequests.length} request${allRequests.length !== 1 ? 's' : ''}`;

            } catch (error) {
                console.error('Error loading requests:', error);
                alert('Error loading requests. Please try again.');
            } finally {
                refreshRequestsBtn.textContent = 'Refresh Requests';
                refreshRequestsBtn.disabled = false;
            }
        }

        function displayRequests() {
            requestsList.innerHTML = '';

            allRequests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'request-item';
                
                const formattedDate = new Date(request.date).toLocaleDateString();
                const formattedTime = request.time;
                
                requestItem.innerHTML = `
                    <div class="request-header">
                        <div class="request-info">
                            <div class="request-title">${request.studentName}</div>
                            <div class="request-details">
                                <strong>Date:</strong> ${formattedDate} | 
                                <strong>Time:</strong> ${formattedTime} | 
                                <strong>Location:</strong> ${request.location}
                                ${request.note ? `<br><strong>Note:</strong> ${request.note}` : ''}
                            </div>
                        </div>
                        <span class="request-status status-${request.status}">${request.status}</span>
                    </div>
                    
                    ${request.status === 'pending' ? `
                        <div class="request-actions">
                            <button class="edit-btn" onclick="editRequest('${request.id}')">Edit</button>
                            <button class="confirm-btn" onclick="confirmRequest('${request.id}')">Confirm</button>
                            <button class="decline-btn" onclick="declineRequest('${request.id}')">Decline</button>
                        </div>
                        
                        <div class="edit-form" id="editForm_${request.id}">
                            <h4>Edit Request</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date:</label>
                                    <input type="date" id="editDate_${request.id}" value="${request.date}">
                                </div>
                                <div class="form-group">
                                    <label>Time:</label>
                                    <select id="editTime_${request.id}">
                                        <option value="09:00" ${request.time === '09:00' ? 'selected' : ''}>09:00</option>
                                        <option value="10:00" ${request.time === '10:00' ? 'selected' : ''}>10:00</option>
                                        <option value="11:00" ${request.time === '11:00' ? 'selected' : ''}>11:00</option>
                                        <option value="12:00" ${request.time === '12:00' ? 'selected' : ''}>12:00</option>
                                        <option value="13:00" ${request.time === '13:00' ? 'selected' : ''}>13:00</option>
                                        <option value="14:00" ${request.time === '14:00' ? 'selected' : ''}>14:00</option>
                                        <option value="15:00" ${request.time === '15:00' ? 'selected' : ''}>15:00</option>
                                        <option value="16:00" ${request.time === '16:00' ? 'selected' : ''}>16:00</option>
                                        <option value="17:00" ${request.time === '17:00' ? 'selected' : ''}>17:00</option>
                                        <option value="18:00" ${request.time === '18:00' ? 'selected' : ''}>18:00</option>
                                        <option value="19:00" ${request.time === '19:00' ? 'selected' : ''}>19:00</option>
                                        <option value="20:00" ${request.time === '20:00' ? 'selected' : ''}>20:00</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Note:</label>
                                <textarea id="editNote_${request.id}">${request.note || ''}</textarea>
                            </div>
                            <div class="edit-form-buttons">
                                <button class="save-edit-btn" onclick="saveEdit('${request.id}')">Save Changes</button>
                                <button class="cancel-edit-btn" onclick="cancelEdit('${request.id}')">Cancel</button>
                            </div>
                        </div>
                        
                        <div class="teacher-selection" id="teacherSelection_${request.id}">
                            <h4>Select Teacher</h4>
                            <div class="teacher-list" id="teacherList_${request.id}">
                                <!-- Teachers will be loaded here -->
                            </div>
                            <button class="confirm-btn" onclick="assignTeacher('${request.id}')" id="assignTeacherBtn_${request.id}" style="display: none;">Assign Teacher & Confirm</button>
                        </div>
                    ` : ''}
                `;
                
                requestsList.appendChild(requestItem);
            });
        }

        // Edit request functionality
        window.editRequest = function(requestId) {
            const editForm = document.getElementById(`editForm_${requestId}`);
            editForm.classList.toggle('show');
        };

        window.saveEdit = async function(requestId) {
            try {
                const newDate = document.getElementById(`editDate_${requestId}`).value;
                const newTime = document.getElementById(`editTime_${requestId}`).value;
                const newNote = document.getElementById(`editNote_${requestId}`).value;

                if (!newDate || !newTime) {
                    alert('Please fill in all required fields.');
                    return;
                }

                // Update request in Firestore
                const requestRef = doc(db, 'requests', requestId);
                await updateDoc(requestRef, {
                    date: newDate,
                    time: newTime,
                    note: newNote
                });

                // Update local data
                const requestIndex = allRequests.findIndex(r => r.id === requestId);
                if (requestIndex !== -1) {
                    allRequests[requestIndex].date = newDate;
                    allRequests[requestIndex].time = newTime;
                    allRequests[requestIndex].note = newNote;
                }

                // Create notification for admin
                await createNotification('admin', 'request_updated', `Request for ${newDate} at ${newTime} has been updated.`);

                // Refresh display
                displayRequests();
                alert('Request updated successfully!');

            } catch (error) {
                console.error('Error updating request:', error);
                alert('Error updating request. Please try again.');
            }
        };

        window.cancelEdit = function(requestId) {
            const editForm = document.getElementById(`editForm_${requestId}`);
            editForm.classList.remove('show');
        };

        // Confirm request functionality
        window.confirmRequest = async function(requestId) {
            try {
                // Load teachers if not already loaded
                if (allTeachers.length === 0) {
                    await loadTeachers();
                }

                const teacherSelection = document.getElementById(`teacherSelection_${requestId}`);
                const teacherList = document.getElementById(`teacherList_${requestId}`);
                
                // Display teachers
                teacherList.innerHTML = '';
                allTeachers.forEach(teacher => {
                    const teacherOption = document.createElement('div');
                    teacherOption.className = 'teacher-option';
                    teacherOption.innerHTML = `
                        <h5>${teacher.username}</h5>
                        <p>${teacher.email} - $${teacher.pricePerClass}/class</p>
                    `;
                    teacherOption.addEventListener('click', () => {
                        // Remove selection from all options
                        document.querySelectorAll(`#teacherList_${requestId} .teacher-option`).forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // Select this option
                        teacherOption.classList.add('selected');
                        teacherOption.dataset.teacherId = teacher.id;
                        
                        // Show assign button
                        document.getElementById(`assignTeacherBtn_${requestId}`).style.display = 'block';
                    });
                    teacherList.appendChild(teacherOption);
                });

                teacherSelection.classList.add('show');
                
                // Hide edit form if open
                const editForm = document.getElementById(`editForm_${requestId}`);
                editForm.classList.remove('show');

            } catch (error) {
                console.error('Error loading teachers:', error);
                alert('Error loading teachers. Please try again.');
            }
        };

        // Load teachers
        async function loadTeachers() {
            try {
                const usersRef = collection(db, 'users');
                const teachersQuery = query(usersRef, where('role', '==', 'teacher'));
                const teachersSnapshot = await getDocs(teachersQuery);

                allTeachers = [];
                teachersSnapshot.forEach(doc => {
                    const teacherData = doc.data();
                    allTeachers.push({
                        id: doc.id,
                        ...teacherData
                    });
                });

            } catch (error) {
                console.error('Error loading teachers:', error);
                throw error;
            }
        }

        // Assign teacher and confirm request
        window.assignTeacher = async function(requestId) {
            const selectedTeacher = document.querySelector(`#teacherList_${requestId} .teacher-option.selected`);
            
            if (!selectedTeacher) {
                alert('Please select a teacher first.');
                return;
            }

            const teacherId = selectedTeacher.dataset.teacherId;
            const request = allRequests.find(r => r.id === requestId);

            if (!request) {
                alert('Request not found.');
                return;
            }

            try {
                // Create class document
                const classData = {
                    studentId: request.studentId,
                    teacherId: teacherId,
                    date: request.date,
                    time: request.time,
                    location: request.location,
                    notes: request.note || '',
                    status: 'confirmed',
                    createdAt: new Date(),
                    requestId: requestId
                };

                const classId = `class_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                await setDoc(doc(db, 'classes', classId), classData);

                // Update request status
                const requestRef = doc(db, 'requests', requestId);
                await updateDoc(requestRef, {
                    status: 'confirmed',
                    teacherId: teacherId,
                    classId: classId,
                    confirmedAt: new Date()
                });

                // Update local data
                const requestIndex = allRequests.findIndex(r => r.id === requestId);
                if (requestIndex !== -1) {
                    allRequests[requestIndex].status = 'confirmed';
                    allRequests[requestIndex].teacherId = teacherId;
                    allRequests[requestIndex].classId = classId;
                }

                // Create notifications
                await createNotification('admin', 'request_confirmed', `Request confirmed and class created for ${request.date} at ${request.time}.`);
                await createNotification(request.studentId, 'request_confirmed', `Your class request for ${request.date} at ${request.time} has been confirmed!`);
                await createNotification(teacherId, 'class_assigned', `You have been assigned a new class on ${request.date} at ${request.time}.`);

                // Refresh display
                displayRequests();
                alert('Request confirmed and class created successfully!');

            } catch (error) {
                console.error('Error confirming request:', error);
                alert('Error confirming request. Please try again.');
            }
        };

        // Decline request functionality
        window.declineRequest = async function(requestId) {
            const confirmed = confirm('Are you sure you want to decline this request?');
            if (!confirmed) return;

            try {
                // Update request status
                const requestRef = doc(db, 'requests', requestId);
                await updateDoc(requestRef, {
                    status: 'declined',
                    declinedAt: new Date()
                });

                // Update local data
                const requestIndex = allRequests.findIndex(r => r.id === requestId);
                if (requestIndex !== -1) {
                    allRequests[requestIndex].status = 'declined';
                }

                // Create notifications
                await createNotification('admin', 'request_declined', `Request declined for ${request.date} at ${request.time}.`);
                await createNotification(request.studentId, 'request_declined', `Your class request for ${request.date} at ${request.time} has been declined.`);

                // Refresh display
                displayRequests();
                alert('Request declined successfully!');

            } catch (error) {
                console.error('Error declining request:', error);
                alert('Error declining request. Please try again.');
            }
        };

        // Admin Calendar Functionality
        let adminCurrentDate = new Date();
        let allClasses = [];
        let allUsers = [];

        // Initialize calendar when tab is shown
        const originalShowTab = window.showTab;
        window.showTab = function(tabName) {
            originalShowTab(tabName);
            
            if (tabName === 'calendar') {
                initializeAdminCalendar();
            } else if (tabName === 'notifications') {
                loadNotifications();
            }
        };

        async function initializeAdminCalendar() {
            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');
            const refreshBtn = document.getElementById('refreshCalendarBtn');
            const userFilter = document.getElementById('userFilter');
            const specificUserFilter = document.getElementById('specificUserFilter');
            
            prevBtn.addEventListener('click', () => {
                adminCurrentDate.setMonth(adminCurrentDate.getMonth() - 1);
                renderAdminCalendar();
            });
            
            nextBtn.addEventListener('click', () => {
                adminCurrentDate.setMonth(adminCurrentDate.getMonth() + 1);
                renderAdminCalendar();
            });
            
            refreshBtn.addEventListener('click', loadAdminCalendarData);
            userFilter.addEventListener('change', updateSpecificUserFilter);
            specificUserFilter.addEventListener('change', renderAdminCalendar);
            
            await loadAdminCalendarData();
            renderAdminCalendar();
        }

        async function loadAdminCalendarData() {
            try {
                // Load all classes
                const classesRef = collection(db, 'classes');
                const classesQuery = query(classesRef);
                const classesSnapshot = await getDocs(classesQuery);

                allClasses = [];
                for (const classDoc of classesSnapshot.docs) {
                    const classData = classDoc.data();
                    
                    // Get student and teacher names
                    let studentName = 'Unknown Student';
                    let teacherName = 'Unknown Teacher';
                    
                    try {
                        const studentDoc = await getDoc(doc(db, 'users', classData.studentId));
                        if (studentDoc.exists()) {
                            studentName = studentDoc.data().username;
                        }
                        
                        const teacherDoc = await getDoc(doc(db, 'users', classData.teacherId));
                        if (teacherDoc.exists()) {
                            teacherName = teacherDoc.data().username;
                        }
                    } catch (error) {
                        console.error('Error fetching user names:', error);
                    }

                    allClasses.push({
                        id: classDoc.id,
                        ...classData,
                        studentName: studentName,
                        teacherName: teacherName
                    });
                }

                // Load all users for filters
                const usersRef = collection(db, 'users');
                const usersQuery = query(usersRef);
                const usersSnapshot = await getDocs(usersQuery);

                allUsers = [];
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    allUsers.push({
                        id: doc.id,
                        ...userData
                    });
                });

            } catch (error) {
                console.error('Error loading calendar data:', error);
                alert('Error loading calendar data. Please try again.');
            }
        }

        function updateSpecificUserFilter() {
            const userFilter = document.getElementById('userFilter');
            const specificUserFilter = document.getElementById('specificUserFilter');
            
            specificUserFilter.innerHTML = '<option value="">Select User</option>';
            
            const filterValue = userFilter.value;
            let filteredUsers = [];
            
            if (filterValue === 'students') {
                filteredUsers = allUsers.filter(user => user.role === 'student');
            } else if (filterValue === 'teachers') {
                filteredUsers = allUsers.filter(user => user.role === 'teacher');
            } else {
                filteredUsers = allUsers;
            }
            
            filteredUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.username} (${user.role})`;
                specificUserFilter.appendChild(option);
            });
        }

        function renderAdminCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            const year = adminCurrentDate.getFullYear();
            const month = adminCurrentDate.getMonth();
            
            // Update month display
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Check if it's current month
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // Check if it's today
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
                
                // Add classes for this day
                const dayClasses = getClassesForDate(date);
                dayClasses.forEach(classItem => {
                    const classContainer = document.createElement('div');
                    classContainer.className = 'class-container';
                    
                    const classElement = document.createElement('div');
                    classElement.className = `class-item ${classItem.type}`;
                    classElement.textContent = `${classItem.time} - ${classItem.name}`;
                    classElement.title = `${classItem.name} - ${classItem.location} - ${classItem.notes || 'No notes'}`;
                    classElement.addEventListener('click', () => showClassDetails(classItem));
                    
                    // Only show cancel button for confirmed classes
                    if (classItem.status === 'confirmed') {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'cancel-btn';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            cancelClass(classItem);
                        });
                        
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'class-actions';
                        actionsDiv.appendChild(cancelBtn);
                        classContainer.appendChild(actionsDiv);
                    }
                    
                    classContainer.appendChild(classElement);
                    dayElement.appendChild(classContainer);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function getClassesForDate(date) {
            const specificUserFilter = document.getElementById('specificUserFilter');
            const selectedUserId = specificUserFilter.value;
            
            const dateString = date.toISOString().split('T')[0];
            let filteredClasses = allClasses.filter(classItem => classItem.date === dateString);
            
            if (selectedUserId) {
                filteredClasses = filteredClasses.filter(classItem => 
                    classItem.studentId === selectedUserId || classItem.teacherId === selectedUserId
                );
            }
            
            return filteredClasses.map(classItem => ({
                ...classItem,
                type: 'confirmed',
                name: `${classItem.studentName} & ${classItem.teacherName}`
            }));
        }

        function showClassDetails(classItem) {
            const detailsHtml = `
                <div class="class-details">
                    <h4>Class Details</h4>
                    <p><strong>Student:</strong> ${classItem.studentName}</p>
                    <p><strong>Teacher:</strong> ${classItem.teacherName}</p>
                    <p><strong>Date:</strong> ${new Date(classItem.date).toLocaleDateString()}</p>
                    <p><strong>Time:</strong> ${classItem.time}</p>
                    <p><strong>Location:</strong> ${classItem.location}</p>
                    <p><strong>Status:</strong> ${classItem.status}</p>
                    ${classItem.notes ? `<div class="notes"><strong>Notes:</strong> ${classItem.notes}</div>` : ''}
                </div>
            `;
            
            alert('Class Details:\n\n' + 
                  `Student: ${classItem.studentName}\n` +
                  `Teacher: ${classItem.teacherName}\n` +
                  `Date: ${new Date(classItem.date).toLocaleDateString()}\n` +
                  `Time: ${classItem.time}\n` +
                  `Location: ${classItem.location}\n` +
                  `Status: ${classItem.status}\n` +
                  (classItem.notes ? `Notes: ${classItem.notes}` : ''));
        }

        // Notifications System
        let allNotifications = [];

        // Create notification function
        async function createNotification(recipientId, type, message, data = {}) {
            try {
                const notificationData = {
                    recipientId: recipientId,
                    type: type,
                    message: message,
                    timestamp: new Date(),
                    read: false,
                    ...data
                };

                const notificationId = `notification_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                await setDoc(doc(db, 'notifications', notificationId), notificationData);
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const notificationsRef = collection(db, 'notifications');
                const notificationsQuery = query(notificationsRef);
                const notificationsSnapshot = await getDocs(notificationsQuery);

                allNotifications = [];
                notificationsSnapshot.forEach(doc => {
                    allNotifications.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by timestamp (newest first)
                allNotifications.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                displayNotifications();
                updateNotificationBadge();

            } catch (error) {
                console.error('Error loading notifications:', error);
                alert('Error loading notifications. Please try again.');
            }
        }

        // Display notifications
        function displayNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            const notificationsCount = document.getElementById('notificationsCount');

            notificationsList.innerHTML = '';

            if (allNotifications.length === 0) {
                notificationsList.innerHTML = '<p>No notifications found.</p>';
                notificationsCount.textContent = '0 notifications';
                return;
            }

            allNotifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                
                const timeAgo = getTimeAgo(notification.timestamp.toDate());
                
                notificationItem.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-type">${getNotificationTypeLabel(notification.type)}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-actions">
                        ${!notification.read ? `<button class="notification-action-btn mark-read-action" onclick="markNotificationRead('${notification.id}')">Mark as Read</button>` : ''}
                        <button class="notification-action-btn delete-action" onclick="deleteNotification('${notification.id}')">Delete</button>
                    </div>
                `;
                
                notificationsList.appendChild(notificationItem);
            });

            const unreadCount = allNotifications.filter(n => !n.read).length;
            notificationsCount.textContent = `${allNotifications.length} notification${allNotifications.length !== 1 ? 's' : ''} (${unreadCount} unread)`;
        }

        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = allNotifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        // Get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Get notification type label
        function getNotificationTypeLabel(type) {
            const labels = {
                'request_created': 'New Request',
                'request_updated': 'Request Updated',
                'request_confirmed': 'Request Confirmed',
                'request_declined': 'Request Declined',
                'class_created': 'Class Created',
                'class_canceled': 'Class Canceled',
                'class_updated': 'Class Updated'
            };
            return labels[type] || type;
        }

        // Mark notification as read
        window.markNotificationRead = async function(notificationId) {
            try {
                const notificationRef = doc(db, 'notifications', notificationId);
                await updateDoc(notificationRef, { read: true });

                // Update local data
                const notificationIndex = allNotifications.findIndex(n => n.id === notificationId);
                if (notificationIndex !== -1) {
                    allNotifications[notificationIndex].read = true;
                }

                displayNotifications();
                updateNotificationBadge();

            } catch (error) {
                console.error('Error marking notification as read:', error);
                alert('Error marking notification as read. Please try again.');
            }
        };

        // Delete notification
        window.deleteNotification = async function(notificationId) {
            try {
                await deleteDoc(doc(db, 'notifications', notificationId));

                // Update local data
                allNotifications = allNotifications.filter(n => n.id !== notificationId);

                displayNotifications();
                updateNotificationBadge();

            } catch (error) {
                console.error('Error deleting notification:', error);
                alert('Error deleting notification. Please try again.');
            }
        };

        // Mark all notifications as read
        document.getElementById('markAllReadBtn').addEventListener('click', async () => {
            try {
                const unreadNotifications = allNotifications.filter(n => !n.read);
                
                for (const notification of unreadNotifications) {
                    const notificationRef = doc(db, 'notifications', notification.id);
                    await updateDoc(notificationRef, { read: true });
                }

                // Update local data
                allNotifications.forEach(n => n.read = true);

                displayNotifications();
                updateNotificationBadge();

            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                alert('Error marking notifications as read. Please try again.');
            }
        });

        // Refresh notifications
        document.getElementById('refreshNotificationsBtn').addEventListener('click', loadNotifications);

        // Load notifications on page load
        loadNotifications();

        // Cancel class function
        async function cancelClass(classItem) {
            const confirmed = confirm(`Are you sure you want to cancel the class between ${classItem.studentName} and ${classItem.teacherName} on ${new Date(classItem.date).toLocaleDateString()} at ${classItem.time}?`);
            
            if (!confirmed) return;

            try {
                // Update class status to canceled
                const classRef = doc(db, 'classes', classItem.id);
                await updateDoc(classRef, {
                    status: 'canceled',
                    canceledAt: new Date(),
                    canceledBy: 'admin'
                });

                // Create notifications
                await createNotification(classItem.studentId, 'class_canceled', `Your class on ${new Date(classItem.date).toLocaleDateString()} at ${classItem.time} has been canceled by admin.`);
                await createNotification(classItem.teacherId, 'class_canceled', `Your class on ${new Date(classItem.date).toLocaleDateString()} at ${classItem.time} has been canceled by admin.`);

                // Update local data
                const classIndex = allClasses.findIndex(c => c.id === classItem.id);
                if (classIndex !== -1) {
                    allClasses[classIndex].status = 'canceled';
                }

                // Refresh display
                renderAdminCalendar();
                
                alert('Class canceled successfully!');

            } catch (error) {
                console.error('Error canceling class:', error);
                alert('Error canceling class. Please try again.');
            }
        }

        // Payment System
        let allStudents = [];
        let allPayments = [];

        // Initialize payment system
        function initializePaymentSystem() {
            // Set current month as default
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('paymentMonth').value = currentMonth;
            
            // Load initial data
            loadPaymentData();
        }

        // Load payment data
        async function loadPaymentData() {
            try {
                // Load all students
                const studentsRef = collection(db, 'users');
                const studentsQuery = query(studentsRef, where('role', '==', 'student'));
                const studentsSnapshot = await getDocs(studentsQuery);
                
                allStudents = [];
                studentsSnapshot.forEach(doc => {
                    allStudents.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Load all teachers
                const teachersRef = collection(db, 'users');
                const teachersQuery = query(teachersRef, where('role', '==', 'teacher'));
                const teachersSnapshot = await getDocs(teachersQuery);
                
                allTeachers = [];
                teachersSnapshot.forEach(doc => {
                    allTeachers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Load all classes
                const classesRef = collection(db, 'classes');
                const classesQuery = query(classesRef);
                const classesSnapshot = await getDocs(classesQuery);
                
                allClasses = [];
                classesSnapshot.forEach(doc => {
                    allClasses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Load payments for current month
                await loadPaymentSummary();

            } catch (error) {
                console.error('Error loading payment data:', error);
                alert('Error loading payment data. Please try again.');
            }
        }

        // Load payment summary for selected month
        window.loadPaymentSummary = async function() {
            const selectedMonth = document.getElementById('paymentMonth').value;
            if (!selectedMonth) return;

            try {
                // Load payments for the selected month
                const paymentsRef = collection(db, 'payments');
                const paymentsQuery = query(paymentsRef, where('month', '==', selectedMonth));
                const paymentsSnapshot = await getDocs(paymentsQuery);
                
                allPayments = [];
                paymentsSnapshot.forEach(doc => {
                    allPayments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Generate payment summary
                generatePaymentSummary(selectedMonth);

            } catch (error) {
                console.error('Error loading payment summary:', error);
                alert('Error loading payment summary. Please try again.');
            }
        };

        // Generate payment summary
        function generatePaymentSummary(month) {
            const paymentSummaries = [];
            let totalStudents = 0;
            let totalClasses = 0;
            let totalRevenue = 0;
            let totalPaid = 0;

            // Process each student
            allStudents.forEach(student => {
                const studentClasses = allClasses.filter(c => 
                    c.studentId === student.id && 
                    c.status === 'confirmed' &&
                    c.date.startsWith(month)
                );

                const canceledClasses = allClasses.filter(c => 
                    c.studentId === student.id && 
                    c.status === 'canceled' &&
                    c.date.startsWith(month)
                );

                const classesTaken = studentClasses.length;
                const classesCanceled = canceledClasses.length;

                if (classesTaken > 0 || classesCanceled > 0) {
                    totalStudents++;
                    totalClasses += classesTaken;

                    // Find teacher for price calculation
                    let totalAmount = 0;
                    studentClasses.forEach(classItem => {
                        const teacher = allTeachers.find(t => t.id === classItem.teacherId);
                        if (teacher && teacher.pricePerClass) {
                            totalAmount += parseFloat(teacher.pricePerClass);
                        }
                    });

                    totalRevenue += totalAmount;

                    // Get existing payment record
                    const existingPayment = allPayments.find(p => p.studentId === student.id && p.month === month);
                    const amountPaid = existingPayment ? parseFloat(existingPayment.amountPaid || 0) : 0;
                    const isFullyPaid = existingPayment ? existingPayment.isFullyPaid || false : false;

                    totalPaid += amountPaid;

                    paymentSummaries.push({
                        studentId: student.id,
                        studentName: student.username,
                        studentEmail: student.email,
                        classesTaken: classesTaken,
                        classesCanceled: classesCanceled,
                        totalAmount: totalAmount,
                        amountPaid: amountPaid,
                        balance: totalAmount - amountPaid,
                        isFullyPaid: isFullyPaid,
                        month: month
                    });
                }
            });

            // Update summary stats
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalClasses').textContent = totalClasses;
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `$${totalPaid.toFixed(2)}`;

            // Display payment summaries
            displayPaymentSummaries(paymentSummaries);
        }

        // Display payment summaries
        function displayPaymentSummaries(summaries) {
            const paymentsList = document.getElementById('paymentsList');
            paymentsList.innerHTML = '';

            if (summaries.length === 0) {
                paymentsList.innerHTML = '<p>No payment data found for this month.</p>';
                return;
            }

            summaries.forEach(summary => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'payment-item';

                const statusClass = summary.isFullyPaid ? 'status-paid' : 
                                  summary.balance > 0 ? 'status-pending' : 'status-overdue';
                const statusText = summary.isFullyPaid ? 'Fully Paid' : 
                                 summary.balance > 0 ? 'Pending' : 'Overdue';

                paymentItem.innerHTML = `
                    <div class="payment-header">
                        <div class="student-info">
                            <h4>${summary.studentName}</h4>
                            <p>${summary.studentEmail}</p>
                        </div>
                        <span class="payment-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="payment-details">
                        <div class="detail-item">
                            <h5>Classes Taken</h5>
                            <span>${summary.classesTaken}</span>
                        </div>
                        <div class="detail-item">
                            <h5>Classes Canceled</h5>
                            <span>${summary.classesCanceled}</span>
                        </div>
                        <div class="detail-item">
                            <h5>Total Amount</h5>
                            <span>$${summary.totalAmount.toFixed(2)}</span>
                        </div>
                        <div class="detail-item">
                            <h5>Amount Paid</h5>
                            <span>$${summary.amountPaid.toFixed(2)}</span>
                        </div>
                        <div class="detail-item">
                            <h5>Balance</h5>
                            <span>$${summary.balance.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="payment-actions">
                        <div class="payment-input">
                            <label>Update Payment:</label>
                            <input type="number" id="payment_${summary.studentId}" 
                                   value="${summary.amountPaid}" min="0" step="0.01" 
                                   placeholder="Enter amount">
                            <button class="update-payment-btn" 
                                    onclick="updatePayment('${summary.studentId}', '${summary.month}')">
                                Update
                            </button>
                        </div>
                        <button class="mark-paid-btn" 
                                onclick="markAsFullyPaid('${summary.studentId}', '${summary.month}')"
                                ${summary.isFullyPaid ? 'disabled' : ''}>
                            Mark as Fully Paid
                        </button>
                    </div>
                `;

                paymentsList.appendChild(paymentItem);
            });
        }

        // Update payment amount
        window.updatePayment = async function(studentId, month) {
            const amountInput = document.getElementById(`payment_${studentId}`);
            const newAmount = parseFloat(amountInput.value) || 0;

            try {
                const paymentId = `payment_${studentId}_${month}`;
                const paymentRef = doc(db, 'payments', paymentId);
                
                await setDoc(paymentRef, {
                    studentId: studentId,
                    month: month,
                    amountPaid: newAmount,
                    updatedAt: new Date(),
                    updatedBy: 'admin'
                }, { merge: true });

                // Reload payment summary
                await loadPaymentSummary();
                
                alert('Payment updated successfully!');

            } catch (error) {
                console.error('Error updating payment:', error);
                alert('Error updating payment. Please try again.');
            }
        };

        // Mark as fully paid
        window.markAsFullyPaid = async function(studentId, month) {
            const summary = allStudents.find(s => s.id === studentId);
            if (!summary) return;

            const studentClasses = allClasses.filter(c => 
                c.studentId === studentId && 
                c.status === 'confirmed' &&
                c.date.startsWith(month)
            );

            let totalAmount = 0;
            studentClasses.forEach(classItem => {
                const teacher = allTeachers.find(t => t.id === classItem.teacherId);
                if (teacher && teacher.pricePerClass) {
                    totalAmount += parseFloat(teacher.pricePerClass);
                }
            });

            try {
                const paymentId = `payment_${studentId}_${month}`;
                const paymentRef = doc(db, 'payments', paymentId);
                
                await setDoc(paymentRef, {
                    studentId: studentId,
                    month: month,
                    amountPaid: totalAmount,
                    isFullyPaid: true,
                    updatedAt: new Date(),
                    updatedBy: 'admin'
                }, { merge: true });

                // Reload payment summary
                await loadPaymentSummary();
                
                alert('Student marked as fully paid!');

            } catch (error) {
                console.error('Error marking as fully paid:', error);
                alert('Error marking as fully paid. Please try again.');
            }
        };

        // Refresh payments
        document.getElementById('refreshPaymentsBtn').addEventListener('click', loadPaymentData);

        // Initialize payment system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize payment system after a short delay to ensure other systems are loaded
            setTimeout(initializePaymentSystem, 1000);
        });
    </script>
</body>
</html>
