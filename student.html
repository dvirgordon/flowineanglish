<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Flow English</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Flow English">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            opacity: 0;
            animation: pageFadeIn 1s ease-out forwards;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background texture */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(1deg); }
            66% { transform: translateY(10px) rotate(-1deg); }
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            animation: contentFadeIn 1.2s ease-out 0.3s forwards;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .calendar-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            padding: 1em 2em;
            background: linear-gradient(135deg, #ff7b7b 0%, #ff6b6b 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .nav-btn:hover {
            background: linear-gradient(135deg, #ff7b7b 0%, #ff6b6b 100%);
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 12px 30px rgba(255, 107, 107, 0.5);
        }
        
        .current-month {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }
        
        .calendar-day-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #666;
        }
        
        .calendar-day {
            background: linear-gradient(135deg, #f8faff 0%, #e8f0fe 100%);
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 2px solid #e8f0fe;
            border-radius: 12px;
            font-weight: 500;
            color: #333;
        }
        
        .calendar-day:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.2);
            border-color: #007bff;
            background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
            z-index: 2;
        }

        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes contentFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .calendar-day.other-month {
            background: #f8f9fa;
            color: #ccc;
            cursor: default;
        }
        
        .calendar-day.past {
            background: #f8f9fa;
            color: #ccc;
            cursor: default;
        }
        
        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
        }
        
        .calendar-day.selected {
            background: #007bff;
            color: white;
        }
        
        /* Request Form Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            font-family: 'Poppins', sans-serif;
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e8f0fe;
            border-radius: 20px;
            font-size: 16px;
            background-color: #f8faff;
            transition: all 0.3s ease;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            background-color: #ffffff;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
            transform: scale(1.02) translateY(-3px);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            transform: scale(1.01) translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .form-group input:disabled {
            background: #f8f9fa;
            color: #666;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .request-btn {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
            color: white;
            padding: 1em 2em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
        }
        
        .request-btn:hover {
            background: linear-gradient(135deg, #00e6b8 0%, #00c4a0 100%);
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 212, 170, 0.5);
        }
        
        .request-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .welcome-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .welcome-section h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .welcome-section p {
            color: #666;
            font-size: 16px;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 16px;
        }
        
        .tabs-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .request-section {
            padding: 20px 0;
        }
        
        .request-section h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .request-section p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .request-calendar {
            margin-top: 20px;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .class-item {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-bottom: 2px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .class-item:hover {
            background: #218838;
        }
        
        .no-classes {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
        
        .class-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .cancel-btn {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .cancel-btn:hover {
            background: #c82333;
        }
        
        .cancel-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .cancellation-notice {
            color: #dc3545;
            font-size: 11px;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard-modern">
        <div class="dashboard-header">
            <h1 class="dashboard-title">🎓 Student Dashboard</h1>
            <p class="dashboard-subtitle">Welcome back! View your confirmed classes and request new ones with style! ✨</p>
        </div>
        
        <!-- Stats Section -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalClasses">0</div>
                <div class="stat-label">Confirmed Classes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingRequests">0</div>
                <div class="stat-label">Pending Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="thisMonth">0</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>
        
        <!-- Tabs Section -->
        <div class="tabs-section">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('calendar')">My Classes</button>
                <button class="tab-button" onclick="showTab('request')">Request Class</button>
            </div>
            
            <!-- Calendar Tab -->
            <div id="calendar" class="tab-content active">
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="nav-btn" id="prevMonth">← Previous</button>
                            <button class="nav-btn" id="nextMonth">Next →</button>
                        </div>
                        <div class="current-month" id="currentMonth"></div>
                    </div>
                    
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Request Tab -->
            <div id="request" class="tab-content">
                <div class="request-section">
                    <h2>Request a New Class</h2>
                    <p>Select a future date on the calendar below to request a class.</p>
                    
                    <div class="request-calendar">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button class="nav-btn" id="reqPrevMonth">← Previous</button>
                                <button class="nav-btn" id="reqNextMonth">Next →</button>
                            </div>
                            <div class="current-month" id="reqCurrentMonth"></div>
                        </div>
                        
                        <div class="calendar-grid" id="reqCalendarGrid">
                            <!-- Request calendar will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Request Class Modal -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Request Class</h2>
            
            <form id="requestForm">
                <div class="form-group">
                    <label for="requestDate">Date:</label>
                    <input type="date" id="requestDate" name="date" disabled>
                </div>
                
                <div class="form-group">
                    <label for="requestTime">Time:</label>
                    <select id="requestTime" name="time" required>
                        <option value="">Select Time</option>
                        <option value="09:00">09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="11:00">11:00</option>
                        <option value="12:00">12:00</option>
                        <option value="13:00">13:00</option>
                        <option value="14:00">14:00</option>
                        <option value="15:00">15:00</option>
                        <option value="16:00">16:00</option>
                        <option value="17:00">17:00</option>
                        <option value="18:00">18:00</option>
                        <option value="19:00">19:00</option>
                        <option value="20:00">20:00</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="requestLocation">Location:</label>
                    <select id="requestLocation" name="location" required>
                        <option value="">Select Location</option>
                        <option value="Nofey Prat">Nofey Prat</option>
                        <option value="Mitzpe Yericho">Mitzpe Yericho</option>
                        <option value="Maale Adumim">Maale Adumim</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="requestNote">Note (Optional):</label>
                    <textarea id="requestNote" name="note" placeholder="Any additional notes or preferences..."></textarea>
                </div>
                
                <button type="submit" class="request-btn" id="requestBtn">Request Class</button>
            </form>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script src="sw-register.js"></script>
    
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js';
        import { doc, setDoc, collection, query, where, getDocs, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';

        let currentUser = null;
        let currentDate = new Date();
        let requestDate = new Date();
        let selectedDate = null;
        let studentClasses = [];
        let pendingRequests = [];

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initializeStudentDashboard();
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
            }
        });

        // Tab functionality
        window.showTab = function(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        };

        // Initialize dashboard
        async function initializeStudentDashboard() {
            // Initialize main calendar
            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');
            
            prevBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            nextBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Initialize request calendar
            const reqPrevBtn = document.getElementById('reqPrevMonth');
            const reqNextBtn = document.getElementById('reqNextMonth');
            
            reqPrevBtn.addEventListener('click', () => {
                requestDate.setMonth(requestDate.getMonth() - 1);
                renderRequestCalendar();
            });
            
            reqNextBtn.addEventListener('click', () => {
                requestDate.setMonth(requestDate.getMonth() + 1);
                renderRequestCalendar();
            });
            
            await loadStudentData();
            updateStats();
            renderCalendar();
            renderRequestCalendar();
        }

        // Load student data
        async function loadStudentData() {
            try {
                // Load confirmed classes
                const classesRef = collection(db, 'classes');
                const classesQuery = query(classesRef, where('studentId', '==', currentUser.uid));
                const classesSnapshot = await getDocs(classesQuery);

                studentClasses = [];
                for (const classDoc of classesSnapshot.docs) {
                    const classData = classDoc.data();
                    
                    // Get teacher name
                    let teacherName = 'Unknown Teacher';
                    try {
                        const teacherDoc = await getDoc(doc(db, 'users', classData.teacherId));
                        if (teacherDoc.exists()) {
                            teacherName = teacherDoc.data().username;
                        }
                    } catch (error) {
                        console.error('Error fetching teacher name:', error);
                    }

                    studentClasses.push({
                        id: classDoc.id,
                        ...classData,
                        teacherName: teacherName
                    });
                }

                // Load pending requests
                const requestsRef = collection(db, 'requests');
                const requestsQuery = query(requestsRef, where('studentId', '==', currentUser.uid), where('status', '==', 'pending'));
                const requestsSnapshot = await getDocs(requestsQuery);

                pendingRequests = [];
                requestsSnapshot.forEach(doc => {
                    pendingRequests.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

            } catch (error) {
                console.error('Error loading student data:', error);
                alert('Error loading data. Please try again.');
            }
        }

        // Update statistics
        function updateStats() {
            const totalClasses = studentClasses.length;
            const pendingCount = pendingRequests.length;
            const thisMonth = getClassesForCurrentMonth().length;

            document.getElementById('totalClasses').textContent = totalClasses;
            document.getElementById('pendingRequests').textContent = pendingCount;
            document.getElementById('thisMonth').textContent = thisMonth;
        }

        function getClassesForCurrentMonth() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            return studentClasses.filter(classItem => {
                const classDate = new Date(classItem.date);
                return classDate.getMonth() === currentMonth && classDate.getFullYear() === currentYear;
            });
        }

        // Render main calendar (confirmed classes)
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Check if it's current month
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // Check if it's today
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
                
                // Add classes for this day
                const dayClasses = getClassesForDate(date);
                if (dayClasses.length > 0) {
                    dayClasses.forEach(classItem => {
                        const classContainer = document.createElement('div');
                        classContainer.className = 'class-container';
                        
                        const classElement = document.createElement('div');
                        classElement.className = 'class-item';
                        classElement.textContent = `${classItem.time} - ${classItem.teacherName}`;
                        classElement.title = `${classItem.teacherName} - ${classItem.location} - ${classItem.notes || 'No notes'}`;
                        classElement.addEventListener('click', () => showClassDetails(classItem));
                        
                        // Check if student can cancel this class
                        const canCancel = canStudentCancelClass(classItem);
                        
                        if (canCancel.canCancel) {
                            const cancelBtn = document.createElement('button');
                            cancelBtn.className = 'cancel-btn';
                            cancelBtn.textContent = 'Cancel';
                            cancelBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                cancelClass(classItem);
                            });
                            
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'class-actions';
                            actionsDiv.appendChild(cancelBtn);
                            classContainer.appendChild(actionsDiv);
                        } else if (!canCancel.canCancel && canCancel.reason) {
                            const noticeDiv = document.createElement('div');
                            noticeDiv.className = 'cancellation-notice';
                            noticeDiv.textContent = canCancel.reason;
                            classContainer.appendChild(noticeDiv);
                        }
                        
                        classContainer.appendChild(classElement);
                        dayElement.appendChild(classContainer);
                    });
                } else if (date.getMonth() === month) {
                    const noClasses = document.createElement('div');
                    noClasses.className = 'no-classes';
                    noClasses.textContent = 'No classes';
                    dayElement.appendChild(noClasses);
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // Render request calendar
        function renderRequestCalendar() {
            const calendarGrid = document.getElementById('reqCalendarGrid');
            const currentMonthElement = document.getElementById('reqCurrentMonth');
            
            // Set Israeli timezone
            const israelTime = new Date().toLocaleString("en-US", {timeZone: "Asia/Jerusalem"});
            const today = new Date(israelTime);
            
            const year = requestDate.getFullYear();
            const month = requestDate.getMonth();
            
            // Update month display
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                // Check if it's current month
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // Check if it's past date
                if (date < today) {
                    dayElement.classList.add('past');
                } else {
                    // Add click event for future dates
                    dayElement.addEventListener('click', () => {
                        selectedDate = date;
                        openRequestModal(date);
                    });
                }
                
                // Check if it's today
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function getClassesForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            return studentClasses.filter(classItem => classItem.date === dateString);
        }

        function showClassDetails(classItem) {
            alert('Class Details:\n\n' + 
                  `Teacher: ${classItem.teacherName}\n` +
                  `Date: ${new Date(classItem.date).toLocaleDateString()}\n` +
                  `Time: ${classItem.time}\n` +
                  `Location: ${classItem.location}\n` +
                  `Status: ${classItem.status}\n` +
                  (classItem.notes ? `Notes: ${classItem.notes}` : ''));
        }

        // Create notification function
        async function createNotification(recipientId, type, message, data = {}) {
            try {
                const notificationData = {
                    recipientId: recipientId,
                    type: type,
                    message: message,
                    timestamp: new Date(),
                    read: false,
                    ...data
                };

                const notificationId = `notification_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                await setDoc(doc(db, 'notifications', notificationId), notificationData);
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Check if student can cancel a class
        function canStudentCancelClass(classItem) {
            // Get current time in Israeli timezone
            const israelTime = new Date().toLocaleString("en-US", {timeZone: "Asia/Jerusalem"});
            const now = new Date(israelTime);
            
            // Get class date
            const classDate = new Date(classItem.date);
            classDate.setHours(0, 0, 0, 0);
            
            // Get today's date
            const today = new Date(now);
            today.setHours(0, 0, 0, 0);
            
            // If class is not today, student can cancel
            if (classDate.getTime() !== today.getTime()) {
                return { canCancel: true };
            }
            
            // If class is today, check if it's before 9:00 AM
            const nineAM = new Date(now);
            nineAM.setHours(9, 0, 0, 0);
            
            if (now < nineAM) {
                return { canCancel: true };
            } else {
                return { 
                    canCancel: false, 
                    reason: 'Cancellation deadline passed (9:00 AM)' 
                };
            }
        }

        // Cancel class function
        async function cancelClass(classItem) {
            const confirmed = confirm(`Are you sure you want to cancel your class with ${classItem.teacherName} on ${new Date(classItem.date).toLocaleDateString()} at ${classItem.time}?`);
            
            if (!confirmed) return;

            try {
                // Update class status to canceled
                const classRef = doc(db, 'classes', classItem.id);
                await updateDoc(classRef, {
                    status: 'canceled',
                    canceledAt: new Date(),
                    canceledBy: currentUser.uid
                });

                // Create notifications
                await createNotification('admin', 'class_canceled', `Class canceled by student: ${new Date(classItem.date).toLocaleDateString()} at ${classItem.time} with ${classItem.teacherName}.`);
                await createNotification(classItem.teacherId, 'class_canceled', `Class canceled by student: ${new Date(classItem.date).toLocaleDateString()} at ${classItem.time}.`);

                // Update local data
                const classIndex = studentClasses.findIndex(c => c.id === classItem.id);
                if (classIndex !== -1) {
                    studentClasses[classIndex].status = 'canceled';
                }

                // Refresh display
                updateStats();
                renderCalendar();
                
                alert('Class canceled successfully!');

            } catch (error) {
                console.error('Error canceling class:', error);
                alert('Error canceling class. Please try again.');
            }
        }

        // Modal functionality
        const requestModal = document.getElementById('requestModal');
        const closeBtn = document.querySelector('.close');
        const requestForm = document.getElementById('requestForm');
        const requestBtn = document.getElementById('requestBtn');

        closeBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === requestModal) {
                closeModal();
            }
        });

        function openRequestModal(date) {
            const dateInput = document.getElementById('requestDate');
            const formattedDate = date.toISOString().split('T')[0];
            dateInput.value = formattedDate;
            requestModal.style.display = 'block';
        }

        function closeModal() {
            requestModal.style.display = 'none';
            requestForm.reset();
        }

        // Form submission
        requestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please log in to request a class.');
                return;
            }
            
            try {
                requestBtn.disabled = true;
                requestBtn.textContent = 'Submitting Request...';
                
                const formData = new FormData(requestForm);
                const date = formData.get('date');
                const time = formData.get('time');
                const location = formData.get('location');
                const note = formData.get('note');
                
                // Validate required fields
                if (!date || !time || !location) {
                    throw new Error('Please fill in all required fields.');
                }
                
                // Create request data
                const requestData = {
                    studentId: currentUser.uid,
                    date: date,
                    time: time,
                    location: location,
                    note: note || '',
                    status: 'pending',
                    createdAt: new Date(),
                    studentEmail: currentUser.email
                };
                
                // Generate unique ID for the request
                const requestId = `request_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Save to Firestore
                await setDoc(doc(db, 'requests', requestId), requestData);
                
                // Create notification for admin
                await createNotification('admin', 'request_created', `New class request from ${currentUser.email} for ${date} at ${time} in ${location}.`);
                
                alert('Class request submitted successfully! A teacher will review your request and get back to you soon.');
                closeModal();
                
            } catch (error) {
                console.error('Error submitting request:', error);
                alert('Error submitting request. Please try again.');
            } finally {
                requestBtn.disabled = false;
                requestBtn.textContent = 'Request Class';
            }
        });
    </script>
</body>
</html>
